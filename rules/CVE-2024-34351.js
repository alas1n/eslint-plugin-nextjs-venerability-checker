module.exports = {
  meta: {
    type: "problem",
    docs: {
      description:
        'Disallow "redirect" calls in server actions in Nextjs >= 13.4.0, < 14.1.1',
      category: "Possible Vulnerabilities",
      recommended: true,
    },
    schema: [],
  },
  create: function (context) {
    function checkFunctionBody(body) {
      const useServerStatement = body.some(
        (statement) =>
          statement.type === "ExpressionStatement" &&
          statement.expression.type === "Literal" &&
          statement.expression.value === "use server"
      );

      if (useServerStatement) {
        const redirectCall = body.some(
          (statement) =>
            statement.type === "ExpressionStatement" &&
            statement.expression.type === "CallExpression" &&
            statement.expression.callee.name === "redirect"
        );

        if (redirectCall) {
          context.report({
            node: body[0],
            message:
              'Server actions should not call "redirect" from the server in Nextjs >= 13.4.0, < 14.1.1',
          });
        }
      }
    }

    return {
      FunctionDeclaration(node) {
        if (node.body.type === "BlockStatement") {
          checkFunctionBody(node.body.body);
        }
      },
      VariableDeclarator(node) {
        if (
          node.init &&
          node.init.type === "ArrowFunctionExpression" &&
          node.init.body.type === "BlockStatement"
        ) {
          checkFunctionBody(node.init.body.body);
        }
      },
    };
  },
};
